<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Travel Planner Pro - No Native Popups</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#FDFDF9',
                        'muji-text': '#333333',
                        'muji-accent': '#4A4A4A',
                        'muji-subtle': '#A9A9A9',
                        'muji-border': '#E5E5E5',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFDF9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #333333; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #daily-map { z-index: 1; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-bottom { z-index: 2 !important; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Modal Transition */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-muji-bg text-muji-text">

<div id="app" class="max-w-md mx-auto bg-muji-bg min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="p-4 pt-6 flex justify-between items-center bg-muji-bg sticky top-0 z-30 shadow-sm">
        <h1 class="text-lg font-bold tracking-widest">TRAVEL LOG</h1>
        <div class="text-right">
            <span class="text-muji-subtle text-xs font-medium">åŒ¯ç‡åƒè€ƒ</span>
            <p class="text-muji-text font-semibold text-sm">1 KRW â‰ˆ {{ exchangeRateKRWtoHKD.toFixed(4) }} HKD</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow overflow-y-auto no-scrollbar pb-28 px-4 pt-2">
        
        <!-- Tab: è¡Œç¨‹ (Itinerary) -->
        <div v-if="activeTab === 'itinerary'">
            <!-- æ—¥æœŸé¸æ“‡å™¨ (*** å·²ä¿®æ­£ ***) -->
            <div class="py-2 mb-4">
                <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2 items-center">
                    <!-- è¡Œå‰æŒ‰éˆ• -->
                    <button @click="selectDate('è¡Œå‰')" 
                            :class="selectedDate === 'è¡Œå‰' ? 'bg-muji-accent text-white' : 'bg-white border border-muji-border'"
                            class="flex-shrink-0 px-5 py-3 rounded-lg shadow-sm transition-colors duration-200">
                        <span class="font-bold text-sm">è¡Œå‰</span>
                    </button>
                    
                    <!-- ä½¿ç”¨ v-if/v-else æ¢ä»¶æ¸²æŸ“ -->
                    <!-- ç•¶æœ‰è¡Œç¨‹æ—¥æœŸæ™‚ï¼Œé¡¯ç¤ºæ—¥æœŸæŒ‰éˆ• -->
                    <template v-if="travelDates.length > 0">
                        <button v-for="date in travelDates" :key="date" @click="selectDate(date)"
                                :class="selectedDate === date ? 'bg-muji-accent text-white' : 'bg-white border border-muji-border'"
                                class="flex-shrink-0 w-20 h-24 flex flex-col justify-center items-center rounded-lg shadow-sm transition-colors duration-200">
                            <span class="font-bold text-xl">{{ getDay(date) }}</span>
                            <span class="text-xs font-medium">{{ getMonth(date) }}</span>
                            <span class="text-[10px] mt-1 truncate w-full text-center px-1" :class="selectedDate === date ? 'text-white/80' : 'text-muji-subtle'">{{ getCityForDate(date) }}</span>
                        </button>
                    </template>
                    <!-- ç•¶æ²’æœ‰è¡Œç¨‹æ—¥æœŸæ™‚ï¼Œé¡¯ç¤ºæç¤ºæ–‡å­— -->
                    <div v-else class="text-sm text-muji-subtle italic ml-4 whitespace-nowrap">
                        æ–°å¢è¡Œç¨‹å¾Œå°‡é¡¯ç¤ºæ—¥æœŸ
                    </div>
                </div>
            </div>

            <!-- å¤©æ°£å¡ç‰‡ -->
            <div v-if="selectedDate !== 'è¡Œå‰'" class="bg-white rounded-xl p-4 flex items-center justify-between shadow-sm my-4 border border-gray-200 min-h-[80px]">
                <div v-if="weatherLoading" class="flex items-center text-muji-subtle text-sm">
                    <svg class="animate-spin h-4 w-4 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    æ›´æ–°å¤©æ°£...
                </div>
                <div v-else-if="currentWeather" class="flex items-center justify-between w-full">
                    <div class="flex items-center">
                        <div class="text-4xl mr-4">{{ currentWeather.icon }}</div>
                        <div>
                            <p class="font-bold text-xl text-muji-text">{{ currentWeather.max }}Â° / {{ currentWeather.min }}Â° C</p>
                            <p class="text-xs text-muji-subtle">{{ currentWeather.desc }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-muji-subtle text-xs font-semibold px-2 py-1 rounded-full bg-gray-100 inline-block mb-1">
                            ğŸ“ {{ currentCity }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¯æ—¥è·¯ç·šåœ°åœ– -->
            <div v-if="selectedDate !== 'è¡Œå‰'" class="mb-6 relative">
                <h2 class="text-xs font-bold text-muji-subtle mb-2 uppercase tracking-wide">ç•¶æ—¥è·¯ç·šé è¦½</h2>
                <div id="daily-map" class="w-full h-40 rounded-xl shadow-sm border border-gray-200 overflow-hidden bg-gray-100"></div>
            </div>

            <!-- æ¨™é¡Œèˆ‡æ–°å¢æŒ‰éˆ• -->
            <div class="flex justify-between items-center mt-2 mb-4">
                <h2 class="text-xl font-bold text-muji-text">{{ contentTitle }}</h2>
                <button @click="openAddModal" class="bg-muji-accent text-white font-bold py-2 px-4 rounded-lg shadow-sm text-sm hover:bg-black transition">+ æ–°å¢</button>
            </div>

            <!-- è¡Œå‰æ¸…å–® -->
            <div v-if="selectedDate === 'è¡Œå‰'">
                <div v-for="(item, index) in preTripList" :key="index" class="bg-white rounded-xl p-4 mb-3 flex items-center justify-between shadow-sm border border-muji-border">
                    <div class="flex items-center">
                        <input type="checkbox" :id="'pre-trip-' + index" v-model="item.done" class="h-5 w-5 rounded border-gray-300 text-muji-accent focus:ring-muji-accent mr-4">
                        <label :for="'pre-trip-' + index" class="text-base" :class="{ 'line-through text-muji-subtle': item.done }">{{ item.task }}</label>
                    </div>
                    <button @click="askDelete('preTrip', index)" class="text-gray-300 hover:text-red-500">Ã—</button>
                </div>
            </div>

            <!-- è¡Œç¨‹åˆ—è¡¨ (å«æ‰‹å‹•äº¤é€šè¼¸å…¥) -->
            <div v-else>
                <div v-if="itineraryWithTravel.length === 0" class="bg-white rounded-xl p-6 text-center text-muji-subtle shadow-sm border border-muji-border border-dashed">
                    <p>é€™å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å–”ï¼</p>
                </div>

                <div class="relative">
                    <!-- å·¦å´æ™‚é–“è»¸ç·š -->
                    <div class="absolute left-[26px] top-4 bottom-4 w-0.5 bg-gray-200 z-0"></div>

                    <div v-for="(item, index) in itineraryWithTravel" :key="item.uiKey">
                        
                        <!-- äº¤é€šæ™‚é–“å¡ç‰‡ (æ‰‹å‹•è¼¸å…¥) -->
                        <div v-if="item.isTravelInfo" class="ml-14 mb-4 relative z-10 group">
                            <div class="bg-gray-50 rounded-lg p-1.5 text-xs text-muji-subtle flex items-center justify-between border border-gray-200 hover:border-muji-accent transition-colors">
                                <div class="flex items-center space-x-1">
                                    <select 
                                        :value="item.mode" 
                                        @change="updateTravelMode(item.targetId, $event.target.value)"
                                        class="bg-transparent border-none focus:ring-0 cursor-pointer text-base p-0 w-8 text-center"
                                    >
                                        <option value="subway">ğŸš‡</option>
                                        <option value="walk">ğŸš¶</option>
                                        <option value="car">ğŸš—</option>
                                        <option value="bus">ğŸšŒ</option>
                                        <option value="taxi">ğŸš•</option>
                                    </select>
                                    <span class="text-[10px] text-gray-400">å‰å¾€ä¸‹ä¸€ç«™</span>
                                </div>
                                <div class="flex items-center">
                                    <input 
                                        type="number" 
                                        :value="item.duration" 
                                        @input="updateTravelTime(item.targetId, $event.target.value)"
                                        placeholder="0"
                                        class="w-10 bg-white border border-gray-300 rounded px-1 py-0.5 text-right font-bold text-muji-accent focus:outline-none focus:border-muji-accent"
                                    >
                                    <span class="ml-1 text-[10px]">åˆ†é˜</span>
                                </div>
                            </div>
                            <div class="absolute -left-[30px] top-1/2 -translate-y-1/2 bg-white border border-gray-200 rounded-full w-5 h-5 flex items-center justify-center z-10">
                                <span class="text-[8px] text-gray-400">â–¼</span>
                            </div>
                        </div>

                        <!-- ä¸€èˆ¬è¡Œç¨‹å¡ç‰‡ -->
                        <div v-else class="mb-6 relative z-10">
                            
                            <div v-if="item.type === 'flight'" class="ml-14 bg-white rounded-xl shadow-sm border border-l-4 border-l-muji-accent border-gray-200 p-4 relative group">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-lg font-mono">{{ item.time }}</span>
                                    <span class="bg-gray-100 text-xs px-2 py-1 rounded">FLIGHT</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="font-bold">{{ item.from }}</span>
                                    <span class="text-gray-400">âœˆï¸</span>
                                    <span class="font-bold">{{ item.to }}</span>
                                </div>
                                <div class="text-xs text-muji-subtle mt-1">{{ item.flightNumber }}</div>
                                <!-- æ“ä½œæŒ‰éˆ•ç¾¤ -->
                                <div class="mt-3 pt-2 border-t border-gray-100 flex justify-end space-x-2">
                                    <button @click="openEditModal(item)" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded relative z-20">ä¿®è¨‚</button>
                                    <button @click.stop="askDelete('itinerary', item.id)" class="text-xs bg-red-50 hover:bg-red-100 text-red-500 px-2 py-1 rounded relative z-20 cursor-pointer">åˆªé™¤</button>
                                </div>
                            </div>

                            <div v-else class="flex items-start">
                                <!-- æ™‚é–“èˆ‡åœ–æ¨™ -->
                                <div class="flex flex-col items-center w-14 flex-shrink-0 bg-muji-bg z-10 pt-1">
                                    <span class="font-bold text-sm font-mono text-muji-accent">{{ item.time }}</span>
                                    <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-lg mt-1 shadow-sm">
                                        {{ item.icon || 'ğŸ“' }}
                                    </div>
                                </div>
                                <!-- å…§å®¹ -->
                                <div class="flex-grow bg-white rounded-xl p-4 shadow-sm border border-muji-border ml-2 relative group">
                                    <p class="font-bold text-muji-text">{{ item.activity }}</p>
                                    <p v-if="item.location" class="text-xs text-muji-subtle mt-1 flex items-center">
                                        ğŸ“ {{ item.location }}
                                    </p>
                                    
                                    <!-- æ“ä½œæŒ‰éˆ•ç¾¤ (Map, Edit, Delete) -->
                                    <div class="mt-3 pt-2 border-t border-gray-100 flex justify-end space-x-2">
                                        <a v-if="item.location" :href="getGoogleMapsUrl(item.location)" target="_blank" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded flex items-center relative z-20">
                                            <span class="mr-1">ğŸ—ºï¸</span>Map
                                        </a>
                                        <button @click="openEditModal(item)" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded relative z-20">ä¿®è¨‚</button>
                                        <button @click.stop="askDelete('itinerary', item.id)" class="text-xs bg-red-50 hover:bg-red-100 text-red-500 px-2 py-1 rounded relative z-20 cursor-pointer">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è³¼ç‰©æ¸…å–® (Shopping) -->
        <div v-if="activeTab === 'shopping'" class="space-y-4">
            <h2 class="text-xl font-bold text-muji-text mt-2 mb-4">è³¼ç‰©æ¸…å–®</h2>
            
            <div class="bg-white rounded-xl p-4 shadow-sm border border-muji-border">
                <div class="flex space-x-2 mb-4">
                    <input v-model="newShoppingItem" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ" class="flex-grow p-2 bg-gray-50 border border-gray-300 rounded-md">
                    <button @click="addShoppingItem" class="bg-muji-accent text-white px-4 rounded-md font-semibold text-sm">æ–°å¢</button>
                </div>

                <div v-if="shoppingList.length === 0" class="text-center text-muji-subtle py-4 text-sm">
                    æ¸…å–®æ˜¯ç©ºçš„ï¼Œå¿«å»åŠ é»æ±è¥¿å§ï¼
                </div>

                <div v-for="(item, index) in shoppingList" :key="item.id" class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                    <div class="flex items-center">
                        <input type="checkbox" :id="'shop-' + item.id" v-model="item.done" class="h-5 w-5 rounded border-gray-300 text-muji-accent focus:ring-muji-accent mr-3">
                        <label :for="'shop-' + item.id" class="text-base" :class="{ 'line-through text-muji-subtle': item.done }">{{ item.name }}</label>
                    </div>
                    <button @click="askDelete('shopping', index)" class="text-gray-300 hover:text-red-500 text-xs">åˆªé™¤</button>
                </div>
            </div>
        </div>

        <!-- Tab: è¨˜å¸³ (Accounting) -->
        <div v-if="activeTab === 'accounting'" class="space-y-5">
            <div class="bg-white rounded-xl p-5 shadow-sm border border-muji-border">
                <div class="text-center mb-4 pb-4 border-b border-gray-100">
                    <p class="text-sm text-muji-subtle">æ—…ç¨‹ç¸½æ”¯å‡º (HKD)</p>
                    <p class="text-4xl font-bold tracking-tight text-muji-text my-1">HK$ {{ accountingStats.total.toFixed(0) }}</p>
                </div>
                <div class="flex justify-between text-center">
                    <div class="w-1/2 border-r border-gray-100">
                        <p class="text-xs text-muji-subtle mb-1">å…¬æ•¸ç¸½é¡ (Shared)</p>
                        <p class="text-lg font-bold text-blue-600">${{ accountingStats.publicTotal.toFixed(0) }}</p>
                        <p class="text-[10px] text-gray-400 mt-1">æ¯äººæ‡‰ä»˜: ${{ accountingStats.perPerson.toFixed(0) }}</p>
                    </div>
                    <div class="w-1/2">
                        <p class="text-xs text-muji-subtle mb-1">ç§æ•¸ç¸½é¡ (Private)</p>
                        <p class="text-lg font-bold text-gray-600">${{ accountingStats.privateTotal.toFixed(0) }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-sm border border-muji-border">
                <h2 class="font-bold text-muji-text mb-3 text-lg">è¨˜ä¸€ç­†</h2>
                <div class="flex bg-gray-100 p-1 rounded-lg mb-3">
                    <button @click="newExpense.type = 'public'" :class="newExpense.type === 'public' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500'" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all">å…¬æ•¸ (Shared)</button>
                    <button @click="newExpense.type = 'private'" :class="newExpense.type === 'private' ? 'bg-white shadow-sm text-gray-600' : 'text-gray-500'" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all">ç§æ•¸ (Private)</button>
                </div>
                <input v-model="newExpense.description" placeholder="é …ç›® (ä¾‹: æ™šé¤ã€ä¼´æ‰‹ç¦®)" class="w-full p-2 mb-2 bg-gray-50 border border-gray-300 rounded-md">
                <div class="flex space-x-2 mb-2">
                    <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-2/3 p-2 bg-gray-50 border border-gray-300 rounded-md">
                    <select v-model="newExpense.currency" class="w-1/3 p-2 bg-gray-50 border border-gray-300 rounded-md"><option value="KRW">KRW</option><option value="HKD">HKD</option></select>
                </div>
                <button @click="addExpense" class="w-full bg-muji-accent text-white py-2.5 rounded-md font-semibold mt-2">æ–°å¢</button>
            </div>

             <div v-for="expense in expenses" :key="expense.id" class="bg-white rounded-lg p-3 mb-2 flex justify-between items-center shadow-sm border border-muji-border">
                <div class="flex items-center">
                    <span :class="expense.type === 'public' ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-500'" class="text-[10px] px-1.5 py-0.5 rounded mr-2 font-bold">
                        {{ expense.type === 'public' ? 'å…¬' : 'ç§' }}
                    </span>
                    <span class="font-bold text-sm">{{ expense.description }}</span>
                </div>
                <div class="text-right">
                    <span class="block font-bold text-sm" :class="expense.type === 'public' ? 'text-blue-600' : 'text-gray-600'">
                        {{ expense.currency }} {{ expense.amount }}
                    </span>
                    <button @click="askDelete('expense', expense.id)" class="text-[10px] text-gray-400 underline">åˆªé™¤</button>
                </div>
            </div>
        </div>
        
        <!-- Tab: è³‡è¨Š (Info) -->
        <div v-if="activeTab === 'info'" class="space-y-4">
             <h2 class="text-xl font-bold text-muji-text mt-2 mb-4">è¨­å®š</h2>
             
             <div class="bg-white rounded-xl p-4 shadow-sm border border-muji-border">
                <h3 class="font-bold text-lg mb-3">åŒ¯ç‡è¨­å®š</h3>
                <div class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md border border-gray-200">
                    <span class="text-muji-subtle font-mono">1 KRW =</span>
                    <input v-model.number="exchangeRateKRWtoHKD" type="number" step="0.0001" class="flex-grow p-1 bg-transparent focus:outline-none font-bold text-muji-text">
                    <span class="text-muji-subtle font-mono">HKD</span>
                </div>
            </div>

             <div class="bg-white rounded-xl p-4 shadow-sm border border-muji-border">
                <h3 class="font-bold text-lg mb-3">åˆ†å¸³äººæ•¸</h3>
                <div class="flex items-center space-x-2">
                    <span class="text-muji-subtle text-sm">ç¸½äººæ•¸:</span>
                    <input v-model.number="travelersCount" type="number" class="w-16 p-1 bg-gray-50 border border-gray-200 rounded text-center font-bold">
                    <span class="text-xs text-gray-400">äºº</span>
                </div>
            </div>

            <!-- å‚™ä»½èˆ‡åˆ†äº« -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-muji-border">
                <h3 class="font-bold text-lg mb-3">å‚™ä»½èˆ‡åˆ†äº«</h3>
                <p class="text-xs text-muji-subtle mb-3">å°‡è¡Œç¨‹åŒ¯å‡ºæˆæª”æ¡ˆï¼Œå‚³é€çµ¦æœ‹å‹åŒ¯å…¥å³å¯åˆ†äº«ã€‚</p>
                <div class="flex space-x-2">
                    <button @click="exportData" class="flex-1 bg-gray-800 text-white py-2 rounded-md text-sm font-bold shadow hover:bg-black transition">
                        ğŸ“¤ åŒ¯å‡ºè¡Œç¨‹æª”æ¡ˆ
                    </button>
                    <label class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 rounded-md text-sm font-bold shadow-sm hover:bg-gray-50 transition text-center cursor-pointer">
                        ğŸ“¥ åŒ¯å…¥è¡Œç¨‹æª”æ¡ˆ
                        <input type="file" @change="importData" accept=".json" class="hidden">
                    </label>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: æ–°å¢/ä¿®è¨‚è¡Œç¨‹ -->
    <transition name="fade">
        <div v-if="isModalOpen" class="fixed inset-0 bg-black/40 z-50 flex items-end sm:items-center justify-center sm:p-4" @click.self="closeModal">
            <div class="bg-white rounded-t-2xl sm:rounded-xl shadow-2xl w-full max-w-sm p-6">
                <h3 class="font-bold text-xl mb-4 text-muji-text">{{ isEditing ? 'ä¿®è¨‚é …ç›®' : 'æ–°å¢é …ç›®' }}</h3>
                <div v-if="selectedDate === 'è¡Œå‰' && !isEditing">
                    <input v-model="newPreTripTask" placeholder="å¾…è¾¦äº‹é …" class="w-full p-3 border border-gray-300 rounded-md mb-4">
                    <button @click="addPreTripItem" class="w-full bg-muji-accent text-white py-3 rounded-md font-semibold">æ–°å¢</button>
                </div>
                <div v-else>
                    <div class="mb-3">
                        <label class="text-xs font-bold text-muji-subtle block mb-1">é¡å‹</label>
                        <select v-model="modalItem.type" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-md"><option value="activity">æ´»å‹•</option><option value="flight">èˆªç­</option></select>
                    </div>
                    <div v-if="modalItem.type === 'activity'">
                        <input v-model="modalItem.time" type="time" class="w-full p-3 mb-2 border border-gray-300 rounded-md">
                        <input v-model="modalItem.activity" placeholder="æ´»å‹•åç¨±" class="w-full p-3 mb-2 border border-gray-300 rounded-md">
                        <input v-model="modalItem.location" placeholder="åœ°é» (åœ°åœ–é¡¯ç¤ºç”¨)" class="w-full p-3 mb-4 border border-gray-300 rounded-md">
                    </div>
                    <div v-if="modalItem.type === 'flight'">
                        <input v-model="modalItem.time" type="time" placeholder="èµ·é£›æ™‚é–“" class="w-full p-3 mb-2 border border-gray-300 rounded-md">
                        <input v-model="modalItem.flightNumber" placeholder="èˆªç­è™Ÿç¢¼" class="w-full p-3 mb-2 border border-gray-300 rounded-md">
                        <div class="flex space-x-2 mb-4"><input v-model="modalItem.from" placeholder="å‡ºç™¼" class="w-1/2 p-3 border border-gray-300 rounded-md"><input v-model="modalItem.to" placeholder="æŠµé”" class="w-1/2 p-3 border border-gray-300 rounded-md"></div>
                    </div>
                    <button @click="handleSaveItem" class="w-full bg-muji-accent text-white py-3 rounded-md font-semibold">{{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'æ–°å¢' }}</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modal: ç¢ºèªåˆªé™¤ (å–ä»£ window.confirm) -->
    <transition name="fade">
        <div v-if="deleteModal.isOpen" class="fixed inset-0 bg-black/40 z-[60] flex items-center justify-center p-4" @click.self="deleteModal.isOpen = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
                <div class="text-4xl mb-3">ğŸ—‘ï¸</div>
                <h3 class="font-bold text-lg mb-2 text-muji-text">ç¢ºå®šåˆªé™¤ï¼Ÿ</h3>
                <p class="text-sm text-muji-subtle mb-6">åˆªé™¤å¾Œç„¡æ³•å¾©åŸæ­¤é …ç›®ã€‚</p>
                <div class="flex space-x-3">
                    <button @click="deleteModal.isOpen = false" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-bold">å–æ¶ˆ</button>
                    <button @click="confirmDelete" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold shadow-md">ç¢ºèªåˆªé™¤</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- Modal: ç³»çµ±è¨Šæ¯ (å–ä»£ alert) -->
    <transition name="fade">
        <div v-if="systemMsg.isOpen" class="fixed inset-0 bg-black/40 z-[70] flex items-center justify-center p-4" @click.self="systemMsg.isOpen = false">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 text-center">
                <h3 class="font-bold text-lg mb-2 text-muji-text">æç¤º</h3>
                <p class="text-sm text-gray-600 mb-6">{{ systemMsg.text }}</p>
                <button @click="systemMsg.isOpen = false" class="w-full bg-muji-accent text-white py-2 rounded-lg font-bold">å¥½çš„</button>
            </div>
        </div>
    </transition>

    <!-- Bottom Navigation -->
    <nav class="bg-white/95 backdrop-blur-sm fixed bottom-0 left-0 right-0 max-w-md mx-auto flex justify-around border-t border-gray-200 z-40 pb-safe">
        <button @click="activeTab = 'itinerary'" class="flex-1 py-3 flex flex-col items-center justify-center transition-colors" :class="activeTab === 'itinerary' ? 'text-muji-accent' : 'text-gray-400'"><span class="text-xl">ğŸ“…</span><span class="text-[10px] font-medium">è¡Œç¨‹</span></button>
        <button @click="activeTab = 'shopping'" class="flex-1 py-3 flex flex-col items-center justify-center transition-colors" :class="activeTab === 'shopping' ? 'text-muji-accent' : 'text-gray-400'"><span class="text-xl">ğŸ›ï¸</span><span class="text-[10px] font-medium">è³¼ç‰©</span></button>
        <button @click="activeTab = 'accounting'" class="flex-1 py-3 flex flex-col items-center justify-center transition-colors" :class="activeTab === 'accounting' ? 'text-muji-accent' : 'text-gray-400'"><span class="text-xl">ğŸ’°</span><span class="text-[10px] font-medium">è¨˜å¸³</span></button>
        <button @click="activeTab = 'info'" class="flex-1 py-3 flex flex-col items-center justify-center transition-colors" :class="activeTab === 'info' ? 'text-muji-accent' : 'text-gray-400'"><span class="text-xl">âš™ï¸</span><span class="text-[10px] font-medium">è¨­å®š</span></button>
    </nav>

</div>

<script>
    const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- ç‹€æ…‹ç®¡ç† ---
            const activeTab = ref('itinerary');
            const selectedDate = ref('è¡Œå‰');
            const isModalOpen = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const mapInstance = ref(null);
            const weatherLoading = ref(false);
            const currentWeather = ref(null);

            // è‡ªè£½ Modal ç‹€æ…‹
            const deleteModal = reactive({ isOpen: false, type: null, id: null });
            const systemMsg = reactive({ isOpen: false, text: '' });

            // --- æ•¸æ“šæ¨¡å‹ ---
            const exchangeRateKRWtoHKD = ref(0.0058);
            const travelersCount = ref(6);
            const preTripList = ref([{ task: 'é è¨‚é¦–çˆ¾é…’åº—', done: true }, { task: 'è³¼è²·æ—…éŠä¿éšª', done: false }]);
            const shoppingList = ref([
                { id: 1, name: 'Olive Young é¢è†œ', done: false },
                { id: 2, name: 'Gentle Monster å¢¨é¡', done: false },
                { id: 3, name: 'æ¿Ÿå·å³¶æ©˜å­å·§å…‹åŠ›', done: false }
            ]);

            const cityCoordinates = {
                'é¦–çˆ¾': { lat: 37.5665, lng: 126.9780 },
                'æ¿Ÿå·': { lat: 33.4996, lng: 126.5312 },
                'é¦™æ¸¯': { lat: 22.3193, lng: 114.1694 }
            };

            const itinerary = ref([
                // Day 1: 24/12 é¦–çˆ¾
                { id: 1, date: '2025-12-24', time: '14:30', type: 'flight', city: 'é¦–çˆ¾', flightNumber: 'KE608', from: 'HKG', to: 'ICN', location: null, travelTime: 0, travelMode: 'subway' },
                { id: 2, date: '2025-12-24', time: '17:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'æ©Ÿå ´å¿«ç·šå¾€å¼˜å¤§', location: 'AREX Station', icon: 'ğŸš†', lat: 37.5575, lng: 126.9245, travelTime: 60, travelMode: 'subway' },
                { id: 3, date: '2025-12-24', time: '19:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'å¼˜å¤§çƒ¤è‚‰æ™šé¤', location: 'Hongdae', icon: 'ğŸ¥©', lat: 37.5563, lng: 126.9225, travelTime: 15, travelMode: 'walk' },
                // Day 2: 25/12 é¦–çˆ¾
                { id: 4, date: '2025-12-25', time: '10:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'æ™¯ç¦å®®', location: 'Gyeongbokgung', icon: 'ğŸ¯', lat: 37.5796, lng: 126.9770, travelTime: 0, travelMode: 'subway' },
                { id: 5, date: '2025-12-25', time: '14:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'åŒ—æ‘éŸ“å±‹æ‘', location: 'Bukchon', icon: 'ğŸ“·', lat: 37.5826, lng: 126.9850, travelTime: 20, travelMode: 'walk' },
                { id: 6, date: '2025-12-25', time: '18:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'æ˜æ´è–èª•ç‡ˆé£¾', location: 'Myeong-dong', icon: 'ğŸ„', lat: 37.5636, lng: 126.9842, travelTime: 30, travelMode: 'subway' },
                // Day 3: 26/12 é¦–çˆ¾
                { id: 7, date: '2025-12-26', time: '11:00', type: 'activity', city: 'é¦–çˆ¾', activity: 'The Hyundai Seoul', location: 'Yeouido', icon: 'ğŸ›ï¸', lat: 37.5260, lng: 126.9284, travelTime: 0, travelMode: 'subway' },
                // Day 4: 27/12 é¦–çˆ¾ -> æ¿Ÿå·
                { id: 8, date: '2025-12-27', time: '11:00', type: 'flight', city: 'æ¿Ÿå·', flightNumber: '7C123', from: 'GMP', to: 'CJU', location: null, travelTime: 0, travelMode: 'car' },
                { id: 9, date: '2025-12-27', time: '15:00', type: 'activity', city: 'æ¿Ÿå·', activity: 'æ¶¯æœˆé‚‘å’–å•¡å»³', location: 'Aewol', icon: 'â˜•', lat: 33.4658, lng: 126.3195, travelTime: 40, travelMode: 'car' },
                // Day 5: 28/12 æ¿Ÿå·
                { id: 10, date: '2025-12-28', time: '10:00', type: 'activity', city: 'æ¿Ÿå·', activity: 'åŸå±±æ—¥å‡ºå³°', location: 'Seongsan', icon: 'â›°ï¸', lat: 33.4580, lng: 126.9425, travelTime: 0, travelMode: 'car' },
                // Day 6: 29/12 æ¿Ÿå·
                { id: 11, date: '2025-12-29', time: '10:00', type: 'activity', city: 'æ¿Ÿå·', activity: 'ç‰›å³¶ä¸€æ—¥éŠ', location: 'Udo', icon: 'ğŸš¢', lat: 33.5042, lng: 126.9538, travelTime: 0, travelMode: 'car' },
                // Day 7: 30/12 æ¿Ÿå·
                { id: 12, date: '2025-12-30', time: '12:00', type: 'activity', city: 'æ¿Ÿå·', activity: 'æ±é–€å¸‚å ´', location: 'Dongmun Market', icon: 'ğŸŠ', lat: 33.5126, lng: 126.5283, travelTime: 0, travelMode: 'car' },
                // Day 8: 31/12 æ¿Ÿå· -> å›ç¨‹
                { id: 13, date: '2025-12-31', time: '14:00', type: 'flight', city: 'æ¿Ÿå·', flightNumber: 'KE100', from: 'CJU', to: 'HKG', location: null, travelTime: 0, travelMode: 'car' },
            ]);

            const expenses = ref([
                { id: 1, description: 'å¼˜å¤§çƒ¤è‚‰ (å…¬æ•¸)', amount: 120000, currency: 'KRW', hkdAmount: 696, type: 'public' },
                { id: 2, description: 'ä¾¿åˆ©åº—é›¶é£Ÿ (ç§æ•¸)', amount: 5000, currency: 'KRW', hkdAmount: 29, type: 'private' },
            ]);
            
            // Modal ç”¨çš„æš«å­˜ç‰©ä»¶
            const modalItem = reactive({ date: '', time: '', type: 'activity', city: '', activity: '', location: '', flightNumber: '', from: '', to: '' });
            const newPreTripTask = ref('');
            const newShoppingItem = ref('');
            const newExpense = reactive({ description: '', amount: null, currency: 'KRW', type: 'public' });

            // --- è¨ˆç®—å±¬æ€§ ---
            const contentTitle = computed(() => (selectedDate.value === 'è¡Œå‰') ? 'è¡Œå‰æ¸…å–®' : `Day ${getDayNumber(selectedDate.value)} è¡Œç¨‹`);
            const travelDates = computed(() => Array.from(new Set(itinerary.value.map(item => item.date))).sort());
            const filteredItinerary = computed(() => itinerary.value.filter(item => item.date === selectedDate.value).sort((a, b) => a.time.localeCompare(b.time)));
            const currentCity = computed(() => filteredItinerary.value.length > 0 ? filteredItinerary.value[0].city : '');
            
            const accountingStats = computed(() => {
                let publicTotal = 0;
                let privateTotal = 0;
                expenses.value.forEach(e => {
                    if (e.type === 'public') publicTotal += e.hkdAmount;
                    else privateTotal += e.hkdAmount;
                });
                return {
                    total: publicTotal + privateTotal,
                    publicTotal: publicTotal,
                    privateTotal: privateTotal,
                    perPerson: publicTotal / travelersCount.value
                };
            });

            const itineraryWithTravel = computed(() => {
                const list = filteredItinerary.value;
                const result = [];
                for (let i = 0; i < list.length; i++) {
                    const currentItem = list[i];
                    result.push({ ...currentItem, uiKey: `item-${currentItem.id}` });
                    if (i < list.length - 1) {
                        const nextItem = list[i+1];
                        result.push({
                            isTravelInfo: true,
                            uiKey: `travel-${currentItem.id}-${nextItem.id}`,
                            targetId: nextItem.id, 
                            duration: nextItem.travelTime || 0,
                            mode: nextItem.travelMode || 'subway'
                        });
                    }
                }
                return result;
            });

            // --- æ–¹æ³• ---
            const selectDate = (date) => { selectedDate.value = date; };
            const getDay = (dateString) => new Date(dateString).getDate();
            const getMonth = (dateString) => (new Date(dateString).getMonth() + 1) + 'æœˆ';
            const getDayNumber = (dateString) => travelDates.value.indexOf(dateString) + 1;
            const getCityForDate = (dateString) => (itinerary.value.find(item => item.date === dateString) || {}).city || '';
            const getGoogleMapsUrl = (location) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
            const showSystemMsg = (text) => { systemMsg.text = text; systemMsg.isOpen = true; };

            // Modal æ“ä½œ
            const openAddModal = () => { 
                isEditing.value = false;
                editingId.value = null;
                Object.assign(modalItem, { time: '', type: 'activity', activity: '', location: '', flightNumber: '', from: '', to: '' });
                isModalOpen.value = true; 
            };

            const openEditModal = (item) => {
                isEditing.value = true;
                editingId.value = item.id;
                Object.assign(modalItem, { ...item });
                isModalOpen.value = true;
            };

            const closeModal = () => { isModalOpen.value = false; };
            
            const addPreTripItem = () => { if (newPreTripTask.value.trim()) { preTripList.value.push({ task: newPreTripTask.value.trim(), done: false }); newPreTripTask.value = ''; closeModal(); } };
            // ç§»é™¤èˆŠçš„åˆªé™¤æ–¹æ³•ï¼Œæ”¹ç”¨ askDelete

            const handleSaveItem = () => {
                if (isEditing.value) {
                    const index = itinerary.value.findIndex(i => i.id === editingId.value);
                    if (index !== -1) {
                        const original = itinerary.value[index];
                        const locationChanged = modalItem.location !== original.location;
                        let newLat = original.lat;
                        let newLng = original.lng;
                        
                        if (locationChanged && modalItem.location) {
                            const city = getCityForDate(original.date);
                            const baseCoords = cityCoordinates[city] || cityCoordinates['é¦–çˆ¾'];
                            newLat = baseCoords.lat + (Math.random() - 0.5) * 0.05;
                            newLng = baseCoords.lng + (Math.random() - 0.5) * 0.05;
                        }

                        itinerary.value[index] = { ...original, ...modalItem, lat: newLat, lng: newLng };
                    }
                } else {
                    if (!selectedDate.value || selectedDate.value === 'è¡Œå‰') return;
                    const city = getCityForDate(selectedDate.value);
                    const baseCoords = cityCoordinates[city] || cityCoordinates['é¦–çˆ¾'];
                    const randomOffset = () => (Math.random() - 0.5) * 0.05;
                    
                    const itemToAdd = { 
                        ...modalItem, 
                        id: Date.now(), 
                        date: selectedDate.value, 
                        city: city,
                        icon: 'ğŸ“',
                        lat: modalItem.type === 'activity' ? baseCoords.lat + randomOffset() : null,
                        lng: modalItem.type === 'activity' ? baseCoords.lng + randomOffset() : null,
                        travelTime: 0,
                        travelMode: city === 'æ¿Ÿå·' ? 'car' : 'subway'
                    };
                    itinerary.value.push(itemToAdd);
                }
                closeModal();
            };

            // --- æ–°å¢ï¼šè‡ªè£½åˆªé™¤ç¢ºèªé‚è¼¯ (å–ä»£ window.confirm) ---
            const askDelete = (type, idOrIndex) => {
                deleteModal.type = type;
                deleteModal.id = idOrIndex;
                deleteModal.isOpen = true;
            };

            const confirmDelete = () => {
                const { type, id } = deleteModal;
                if (type === 'itinerary') {
                    itinerary.value = itinerary.value.filter(item => item.id != id);
                } else if (type === 'preTrip') {
                    preTripList.value.splice(id, 1);
                } else if (type === 'shopping') {
                    shoppingList.value.splice(id, 1);
                } else if (type === 'expense') {
                    expenses.value = expenses.value.filter(e => e.id !== id);
                }
                deleteModal.isOpen = false;
            };

            const updateTravelTime = (itemId, value) => { const item = itinerary.value.find(i => i.id === itemId); if (item) item.travelTime = parseInt(value) || 0; };
            const updateTravelMode = (itemId, value) => { const item = itinerary.value.find(i => i.id === itemId); if (item) item.travelMode = value; };

            const addShoppingItem = () => {
                if (newShoppingItem.value.trim()) {
                    shoppingList.value.push({ id: Date.now(), name: newShoppingItem.value.trim(), done: false });
                    newShoppingItem.value = '';
                }
            };
            
            const addExpense = () => {
                if (newExpense.amount > 0) {
                    const amount = parseFloat(newExpense.amount);
                    expenses.value.unshift({ 
                        ...newExpense, 
                        id: Date.now(), 
                        amount, 
                        hkdAmount: newExpense.currency === 'KRW' ? amount * exchangeRateKRWtoHKD.value : amount 
                    });
                    newExpense.description = ''; newExpense.amount = null;
                }
            };

            // --- åŒ¯å‡ºèˆ‡åŒ¯å…¥åŠŸèƒ½ (å–ä»£ alert) ---
            const exportData = () => {
                const data = {
                    itinerary: itinerary.value,
                    expenses: expenses.value,
                    shoppingList: shoppingList.value,
                    preTripList: preTripList.value,
                    travelersCount: travelersCount.value,
                    exchangeRateKRWtoHKD: exchangeRateKRWtoHKD.value
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'travel_plan_backup.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // ç§»é™¤ confirmï¼Œç›´æ¥åŒ¯å…¥
                        if (data.itinerary) itinerary.value = data.itinerary;
                        if (data.expenses) expenses.value = data.expenses;
                        if (data.shoppingList) shoppingList.value = data.shoppingList;
                        if (data.preTripList) preTripList.value = data.preTripList;
                        if (data.travelersCount) travelersCount.value = data.travelersCount;
                        if (data.exchangeRateKRWtoHKD) exchangeRateKRWtoHKD.value = data.exchangeRateKRWtoHKD;
                        showSystemMsg('åŒ¯å…¥æˆåŠŸï¼');
                    } catch (err) {
                        showSystemMsg('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•åŒ¯å…¥ã€‚');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; 
            };

            // --- å¤©æ°£ & åœ°åœ– (å¼·åŒ–éŒ¯èª¤è™•ç†) ---
            const wmoToEmoji = (code) => {
                if (code === 0) return 'â˜€ï¸'; if (code >= 1 && code <= 3) return 'â›…ï¸'; if (code >= 45 && code <= 48) return 'ğŸŒ«ï¸'; if (code >= 51 && code <= 67) return 'ğŸŒ§ï¸'; if (code >= 71 && code <= 77) return 'â„ï¸'; if (code >= 80 && code <= 82) return 'ğŸŒ¦ï¸'; if (code >= 95) return 'â›ˆï¸'; return 'â˜ï¸';
            };

            const fetchWeather = async () => {
                if (selectedDate.value === 'è¡Œå‰') return;
                const city = currentCity.value;
                if (!city || !cityCoordinates[city]) return;
                const { lat, lng } = cityCoordinates[city];
                const date = selectedDate.value;
                weatherLoading.value = true;
                currentWeather.value = null;
                
                // é è¨­é›¢ç·šæ•¸æ“š
                const fallbackWeather = { max: city === 'æ¿Ÿå·' ? 12 : 2, min: city === 'æ¿Ÿå·' ? 6 : -5, icon: city === 'æ¿Ÿå·' ? 'â›…ï¸' : 'â„ï¸', desc: 'æ­·å²å¹³å‡ (é›¢ç·š)' };

                try {
                    // å˜—è©¦æŠ“å–ï¼Œå¦‚æœç’°å¢ƒä¸å…è¨± fetch æœƒç›´æ¥è·³åˆ° catch
                    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${date}&end_date=${date}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Network response was not ok');
                    const data = await res.json();
                    
                    if (data.daily && data.daily.time.length > 0) {
                        currentWeather.value = { max: data.daily.temperature_2m_max[0], min: data.daily.temperature_2m_min[0], icon: wmoToEmoji(data.daily.weather_code[0]), desc: 'Open-Meteo é æ¸¬' };
                    } else {
                        currentWeather.value = fallbackWeather;
                    }
                } catch (e) { 
                    // éœé»˜å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼ï¼Œä¸è®“ç¨‹å¼å´©æ½°
                    console.log("Weather fetch skipped/failed (using fallback):", e); 
                    currentWeather.value = fallbackWeather;
                } finally { 
                    weatherLoading.value = false; 
                }
            };

            const renderDailyMap = () => {
                const mapContainer = document.getElementById('daily-map');
                if (!mapContainer) return;
                
                // å¦‚æœ Leaflet æœªè¼‰å…¥ (ä¾‹å¦‚ç„¡ç¶²è·¯)ï¼Œç›´æ¥ä¸æ¸²æŸ“åœ°åœ–
                if (typeof L === 'undefined') {
                    mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-xs text-gray-400">åœ°åœ–ç„¡æ³•è¼‰å…¥ (é›¢ç·šæ¨¡å¼)</div>';
                    return;
                }

                if (mapInstance.value) { mapInstance.value.remove(); mapInstance.value = null; }
                const dayPoints = filteredItinerary.value.filter(item => item.lat && item.lng);
                
                try {
                    if (dayPoints.length === 0) {
                        const city = currentCity.value;
                        const center = cityCoordinates[city] || cityCoordinates['é¦–çˆ¾'];
                        mapInstance.value = L.map('daily-map').setView([center.lat, center.lng], 11);
                    } else {
                        mapInstance.value = L.map('daily-map');
                        const latLngs = [];
                        dayPoints.forEach((item) => {
                            L.marker([item.lat, item.lng]).addTo(mapInstance.value).bindPopup(`<b>${item.time}</b><br>${item.activity}`);
                            latLngs.push([item.lat, item.lng]);
                        });
                        if (latLngs.length > 1) { L.polyline(latLngs, { color: '#4A4A4A', weight: 3, dashArray: '5, 10' }).addTo(mapInstance.value); }
                        const bounds = L.latLngBounds(latLngs);
                        mapInstance.value.fitBounds(bounds, { padding: [30, 30] });
                    }
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance.value);
                } catch (e) {
                    console.error("Map render failed:", e);
                }
            };

            watch(selectedDate, async (newVal) => { if (newVal !== 'è¡Œå‰' && activeTab.value === 'itinerary') { fetchWeather(); await nextTick(); renderDailyMap(); } }, { immediate: true });
            watch(activeTab, async (newVal) => { if (newVal === 'itinerary' && selectedDate.value !== 'è¡Œå‰') { await nextTick(); renderDailyMap(); } });
            
            // ç›£è½è¡Œç¨‹è®Šå‹•ä»¥æ›´æ–°åœ°åœ–
            watch(filteredItinerary, async () => {
                if (activeTab.value === 'itinerary' && selectedDate.value !== 'è¡Œå‰') {
                    await nextTick();
                    renderDailyMap();
                }
            }, { deep: true });

            return {
                activeTab, exchangeRateKRWtoHKD, selectedDate, travelDates, filteredItinerary, itineraryWithTravel, contentTitle, currentCity, selectDate, getDay, getMonth, getDayNumber, getCityForDate,
                preTripList, addPreTripItem,
                isModalOpen, openAddModal, openEditModal, closeModal, isEditing, modalItem, newPreTripTask, handleSaveItem,
                expenses, newExpense, accountingStats, addExpense, travelersCount,
                updateTravelTime, updateTravelMode,
                weatherLoading, currentWeather, getGoogleMapsUrl,
                shoppingList, newShoppingItem, addShoppingItem,
                exportData, importData,
                // æ–°å¢çš„ç‹€æ…‹èˆ‡æ–¹æ³•
                deleteModal, systemMsg, askDelete, confirmDelete, showSystemMsg
            };
        }
    }).mount('#app');
</script>

</body>
</html>
